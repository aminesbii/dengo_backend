import multer from "multer";
import path from "path";
import fs from "fs";

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    try {
      // Determine entity from request URL or provided field
      const original = req.originalUrl || req.url || "";
      const parts = original.split("/").filter(Boolean);
      // Prefer the last segment of the path as the entity (e.g. 'products', 'shops')
      let entity = "uploads";
      const last = parts[parts.length - 1];
      if (last && !["api", "admin", "vendor"].includes(last.toLowerCase())) {
        entity = last;
      } else {
        const apiIdx = parts.indexOf("api");
        if (apiIdx >= 0) {
          if (parts[apiIdx + 1] === "admin" || parts[apiIdx + 1] === "vendor") {
            entity = parts[apiIdx + 2] || parts[apiIdx + 1] || entity;
          } else {
            entity = parts[apiIdx + 1] || entity;
          }
        }
      }

      // Normalize entity name (singular)
      entity = (entity || "uploads").toString().toLowerCase();

      // Create an autogenerated folder (timestamp + random)
      const folderName = `${Date.now().toString(36)}-${Math.round(Math.random() * 1e6)}`;

      const dest = path.join(process.cwd(), "src", "images", entity, folderName);
      fs.mkdirSync(dest, { recursive: true });

      // expose created folder info to request for later use if needed
      req._upload = req._upload || {};
      req._upload.entity = entity;
      req._upload.folder = folderName;
      req._upload.dest = dest;

      cb(null, dest);
    } catch (err) {
      cb(err);
    }
  },
  filename: (req, file, cb) => {
    let ext = path.extname(file.originalname || "").toLowerCase();
    if (![".jpeg", ".jpg", ".png", ".webp"].includes(ext)) {
      // Derive extension from MIME type (common with mobile uploads)
      const mimeMap = { "image/jpeg": ".jpg", "image/png": ".png", "image/webp": ".webp" };
      ext = mimeMap[file.mimetype] || ".jpg";
    }
    const unique = `${Date.now()}-${Math.round(Math.random() * 1e9)}`;
    cb(null, `${unique}${ext}`);
  },
});

const fileFilter = (req, file, cb) => {
  const allowedTypes = /jpeg|jpg|png|webp/;
  const extname = allowedTypes.test(path.extname(file.originalname || "").toLowerCase());
  const mimeType = allowedTypes.test(file.mimetype);

  // Accept if MIME type matches (extension may be missing from mobile uploads)
  if (mimeType || extname) {
    cb(null, true);
  } else {
    cb(new Error("Only image files are allowed (jpeg,jpg,png,webp)"));
  }
};

export const upload = multer({
  storage,
  fileFilter,
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB limit
});